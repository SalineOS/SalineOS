#!/bin/bash
# Licensed under the GNU General Public License Version 2
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA
####################################################################################################
# Copyright 2012 Anthony Nordquist http://www.salineos.com salinelinux@gmail.com 

Icon="--window-icon=/usr/share/pixmaps/clean.png"

Progress='yad --center --progress --auto-close --title=Clean --no-buttons'

tail -f /usr/bin/Clean | $Progress $Icon --pulsate --text="     Calculating size of files     " &

FlashCookieSize=$(du -chs --apparent-size $HOME/.adobe $HOME/.macromedia/Flash_Player | grep 'total' | awk -F ' ' '{print $1}')

PackageCacheSize=$(du -chs --apparent-size /var/cache/apt/archives | grep 'total' | awk -F ' ' '{print $1}')

LogsSize=$(du -chs --apparent-size $HOME/.xsession-errors | grep 'total' | awk -F ' ' '{print $1}')

ThumbnailsSize=$(du -chs --apparent-size $HOME/.thumbnails | grep 'total' | awk -F ' ' '{print $1}')

## Calculate the size saved by removing un-needed packages

PackageList=$(apt-get -s autoremove | grep '  ' | grep -v "This is only a simulation" | grep -v "root privileges for real" | grep -v "Keep also in mind that locking" | grep -v "depend on the relevance to the real")

if [ "$PackageList" = "" ]; then
 FinalSize="0"
else
 for i in $PackageList; do
  SizeStart=$(aptitude show "$i" | grep "Uncompressed Size" | awk -F ':' '{print $2}')
  if [ "$(echo "$SizeStart" | grep "M")" != "" ]; then 
   if [ "$(echo $SizeTemp | grep ',')" != "" ]; then
     SizeTemp=$(echo $SizeTemp | sed -e "s|,||g")
    fi
    SizeTemp=$(echo "$SizeStart" | awk -F ' ' '{print $1}')
    if [ "$(echo $SizeTemp | grep '.')" != "" ]; then
     SizeTemp=$(echo $SizeTemp | awk -F '.' '{print $1}')
    fi 
   FinalSize=$(($FinalSize + $SizeTemp))
  else 
   SizeTemp=$(echo "$SizeStart" | awk -F ' ' '{print $1}')
    if [ "$(echo $SizeTemp | grep ',')" != "" ]; then
     SizeTemp=$(echo $SizeTemp | sed -e "s|,||g")
    fi
    if [ "$(echo $SizeTemp | grep '.')" != "" ]; then
     SizeTemp=$(echo $SizeTemp | awk -F '.' '{print $1}')
    fi
   SizeInM=$(($SizeTemp/1024))
   FinalSize=$(($FinalSize + $SizeInM))
  fi
 done
fi

sleep 3

killall -KILL tail

Operation=$(yad $Icon --button=$"Exit:3" --button=$"gtk-ok:2" --list --text="Please select the actions you wish to perform" --height="250" --checklist --multiple --on-top --column=' ' --column="Action" --column="Size" --title="Clean" --print-column="2" X Flash-Cookies "$FlashCookieSize" X Logs "$LogsSize" X Package-Cache "$PackageCacheSize" X Un-Needed-Packages "$FinalSize"M X Thumbnails "$ThumbnailsSize")

ret=$?

Operation=$(echo "$Operation" | sed -e "s/|//g")

if [ "$ret" = "252" ]; then
 exit 0
elif [ "$ret" = "3" ]; then
 exit 0 
fi


if [ "$(echo "$Operation" | grep Flash-Cookies)" != "" ]; then
 rm -rf $HOME/.adobe
 rm -rf $HOME/.macromedia/Flash_Player
 mkdir -p $HOME/.adobe
 mkdir -p $HOME/.macromedia/Flash_Player
fi
if [ "$(echo "$Operation" | grep Package-Cache)" != "" ]; then
 gksudo apt-get clean
fi
if [ "$(echo "$Operation" | grep Logs)" != "" ]; then
 rm $HOME/.xsession-errors
 touch $HOME/.xsession-errors
fi
if [ "$(echo "$Operation" | grep Thumbnails)" != "" ]; then
 rm -rf $HOME/.thumbnails
 mkdir -p $HOME/.thumbnails
fi
if [ "$(echo "$Operation" | grep Packages)" != "" ]; then
 DialogText="$(apt-get -s autoremove | grep '  ')"
 yad $Icon --on-top --wrap --center --title="Clean" --image=gtk-dialog-question --text="The following packages will be removed:\n\n$DialogText" --button=$"gtk-no:1" --button=$"gtk-yes:0"
 if [ "$?" = "0" ]; then
  gksudo apt-get -y autoremove
 fi
fi
exit 
